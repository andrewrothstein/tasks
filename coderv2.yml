---
version: '3'
includes:
  postgresql: bitnami-postgresql.yml
  coderv2-helm-repo: helm-repo.yml
  coderv2-secret: k8s-literal-secret.yml
  coderv2: helm.yml
tasks:
  default:
    deps:
      - task: install
  install:
    vars:
      name: '{{ .name | default "coder" }}'
      chart_repo_name: '{{ .chart_repo_name | default "coder-v2" }}'
      chart: '{{ .chart | default "coder" }}'
      chart_ver: '{{ .chart_ver | default "0.23.7" }}'
      create_namespace: '{{ .create_namespace | default "true" }}'
      namespace: '{{ .namespace | default "coder" }}'
      admin_username: '{{ .admin_username | default "coder" }}'
      admin_password: '{{ .admin_password | default "e7c32e46-bd6f-11ed-9c8d-38d54714ef1a" }}'
      admin_db: '{{ .admin_db | default "coder" }}'
      db_size: '{{ .db_size | default "10gi" }}'
    cmds:
      - task: postgresql:install
        vars:
          namespace: '{{ .namespace }}'
          create_namespace: '{{ .create_namespace }}'
          admin_username: '{{ .admin_username }}'
          admin_password: '{{ .admin_password }}'
          admin_db: '{{ .admin_db }}'
          db_size: '{{ .db_size }}'
      - task: coderv2-helm-repo:add
        vars:
          n: coder-v2
          url: https://helm.coder.com/v2
      - task: coderv2-secret:create
        vars:
          n: '{{ .namespace }}'
          s: coder-db-url
          args: >-
            --from-literal=url="postgres://{{ .admin_username }}:{{ .admin_password }}@postgresql:5432/{{ .admin_db }}?sslmode=disable"
      - task: coderv2:install
        vars:
          namespace: '{{ .namespace }}'
          name: '{{ .name }}'
          chart_repo_name: '{{ .chart_repo_name }}'
          chart: '{{ .chart }}'
          chart_ver: '{{ .chart_ver }}'
          helm_args: -f coderv2/values.yml
  delete:
    vars:
      name: '{{ .name | default "coder" }}'
      namespace: '{{ .namespace | default "coder" }}'
    cmds:
      - task: coderv2:delete
        vars:
          namespace: '{{ .namespace }}'
          name: '{{ .name }}'
      - task: coderv2-secret:delete
        vars:
          n: '{{ .namespace }}'
          k: url
      - task: postgresql:delete
        vars:
          namespace: coder
