---
version: '3'
dotenv:
  - .coderv2-secrets.env
includes:
  kk:
    taskfile: kubectl.yml
    vars:
      n: coder
      labels: istio.io/dataplane-mode=ambient
  coderv2-secret:
    taskfile: k8s-literal-secret.yml
    vars:
      n: coder
      s: coder-db-url
  postgresql:
    taskfile: bitnami-postgresql.yml
    vars:
      namespace: coder
  repo: coderv2-repo.yml
  coderv2:
    taskfile: helm.yml
    vars:
      chart_repo_name: coder-v2
      chart: coder
      chart_ver: 2.15.0
      name: coder
      namespace: coder
      helm_args: -f coderv2-values.yml
tasks:
  default:
    deps:
      - task: upgrade
  upgrade:
    vars:
      admin_username: '{{ .admin_username | default "coder" }}'
      admin_db: '{{ .admin_db | default "coder" }}'
      db_size: '{{ .db_size | default "10gi" }}'
    cmds:
      - task: kk:ns-create
#      - task: kk:ns-label
      - task: postgresql:upgrade
        vars:
          admin_username: '{{ .admin_username }}'
          admin_password: '{{ .admin_password }}'
          admin_db: '{{ .admin_db }}'
          db_size: '{{ .db_size }}'
      - task: repo
      - task: coderv2-secret:create
        vars:
          args: >-
            --from-literal=url="postgres://{{ .admin_username }}:${POSTGRES_PASSWORD}@postgresql:5432/{{ .admin_db }}?sslmode=disable"
      - task: coderv2:upgrade
        vars:
  delete:
    cmds:
      - task: coderv2:delete
      - task: coderv2-secret:delete
      - task: postgresql:delete
      - task: kk:ns-delete
  check:
    cmds:
      - task: postgresql:check
      - task: coderv2:check
