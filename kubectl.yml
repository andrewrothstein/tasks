---
version: '3'
tasks:
  ns-label:
    vars:
      n: '{{ .n | default "default" }}'
      labels: '{{ .labels }}'
      overwrite: '{{ .overwrite | default "true" }}'
    cmds:
      - |
        {{- if .labels }}
        kubectl label namespace {{ .n | quote }} \
          {{ .labels | quote }}
          {{- if eq .overwrite "true" }} \
          --overwrite
          {{- end }}
        {{- else }}
        # no labels to apply to {{ .n | quote }}
        {{- end }}
  ns-create:
    vars:
      n: '{{ .n | default "default" }}'
    cmds:
      - kubectl create namespace {{ .n | quote }}
    status:
      - kubectl get namespace {{ .n | quote }}
  ns-delete:
    vars:
      n: '{{ .n }}'
    cmds:
      - kubectl delete namespace {{ .n | quote }}
  _apply:
    internal: true
    vars:
      verb: '{{ .verb }}'
      n: '{{ .n }}'
      f: '{{ .f }}'
      literal_f: '{{ .literal_f }}'
    cmds:
      - |
        kubectl \
          {{ .verb }}
          {{- if .n }} \
          -n {{ .n | quote }}
          {{- end }} \
          -f
          {{- if .literal_f }} - <<EOF
        {{ .literal_f }}
        EOF
          {{- else }} {{ .f | quote }}
          {{- end }}
  apply:
    vars:
      n: '{{ .n }}'
      f: '{{ .f }}'
      literal_f: '{{ .literal_f }}'
    cmds:
      - task: _apply
        vars:
          verb: apply
          n: '{{ .n }}'
          f: '{{ .f }}'
          literal_f: '{{ .literal_f }}'
  delete:
    vars:
      n: '{{ .n }}'
      f: '{{ .f }}'
      literal_f: '{{ .literal_f }}'
    cmds:
      - task: _apply
        vars:
          verb: delete
          n: '{{ .n }}'
          f: '{{ .f }}'
          literal_f: '{{ .literal_f }}'
  kapply:
    vars:
      n: '{{ .n | default "default" }}'
      k: '{{ .k }}'
    cmds:
      - |
        kubectl \
          apply \
          {{ if .n }} -n {{ .n | quote }}{{ end }} \
          -k {{ .k | quote }}
  kdelete:
    vars:
      n: '{{ .n | default "default" }}'
      k: '{{ .k }}'
    preconditions:
      - kubectl get namespace {{ .n | quote }}
    cmds:
      - |
        kubectl \
          delete \
          {{ if .n }} -n {{ .n | quote }}{{ end }} \
          -k {{ .k | quote }}
  patch:
    vars:
      n: '{{ .n | default "default" }}'
      typeofthing: '{{ .typeofthing }}'
      thingname: '{{ .thingname }}'
      ty: '{{ .ty }}'
      patch: '{{ .patch }}'
    cmds:
      - |
        kubectl \
          -n {{ .n | quote }} \
          patch \
          {{ .typeofthing | quote }} \
          {{ .thingname | quote }} \
          "--type={{ .ty }}" \
          --patch {{ .patch | quote }}
  wait-for-pod:
    vars:
      for: '{{ .for }}'
      n: '{{ .n | default "default" }}'
      k: '{{ .k }}'
      v: '{{ .v }}'
    cmds:
      - |
          kubectl \
            wait --for={{ .for }} \
            -n {{ .n | quote }} pod \
            -l '{{ .k }}={{ .v }}'
  wait-for-pod-ready:
    vars:
      n: '{{ .n | default "default" }}'
      k8s_app: '{{ .k8s_app }}'
    deps:
      - task: wait-for-pod
        vars:
          for: condition=ready
          n: '{{ .n | default "default" }}'
          k: k8s-app
          v: '{{ .k8s_app }}'
