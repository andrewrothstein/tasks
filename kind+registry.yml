---
version: '3'
includes:
  docker-registry: docker-registry.yml
  kind: kind.yml
  docker-network: docker-network.yml
tasks:
  up:
    vars:
      disableDefaultCNI: '{{ .disableDefaultCNI | default false }}'
    deps:
      - task: docker-registry:apply
    cmds:
      - task: kind:up
        vars:
          f: chart-kind/registry-values.yaml
          disableDefaultCNI: '{{ .disableDefaultCNI }}'
      - |+
        REGISTRY_ROOT_DIR="/etc/containerd/certs.d"
        for node in $(kind get nodes); do
          for r in \
            docker.io \
            quay.io \
            gcr.io \
            ghcr.io \
            k8s.gcr.io \
            registry.k8s.io; do
              h="$r"
              if [ "${r}" == "docker.io" ]; then
                h="registry-1.docker.io"
              fi
              REGISTRY_DIR="${REGISTRY_ROOT_DIR}/${r}"
              docker exec "${node}" mkdir -p "${REGISTRY_DIR}"
              docker exec -i "${node}" cp /dev/stdin "${REGISTRY_DIR}/hosts.toml" <<EOF
        server = "https://${h}"
        [host."http://kind-registry:5000"]
        	capabilities = ["pull", "resolve"]
        EOF
          done
        done
      - task: docker-network:connect
        vars:
          net: kind
          container: kind-registry
      - |
        kubectl apply -f - <<EOF
        ---
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: local-registry-hosting
          namespace: kube-public
        data:
          localRegistryHosting.v1: |
            host: "localhost:5000"
            help: "https://kind.sigs.k8s.io/docs/user/local-registry/"
        EOF
  delete:
    cmds:
      - task: kind:delete
      - task: docker-registry:delete
