---
version: '3'
includes:
  docker-registry: docker-registry.yml
  kind: kind.yml
  docker-network: docker-network.yml
tasks:
  up:
    vars:
      disableDefaultCNI: '{{ .disableDefaultCNI | default false }}'
    deps:
      - task: docker-registry:apply
    cmds:
      - task: kind:up
        vars:
          f: chart-kind/registry-values.yaml
          disableDefaultCNI: '{{ .disableDefaultCNI }}'
      - |+
        REGISTRY_DIR="/etc/containerd/certs.d/localhost:5000"
        for node in $(kind get nodes); do
          docker exec "${node}" mkdir -p "${REGISTRY_DIR}"
          docker exec -i "${node}" cp /dev/stdin "${REGISTRY_DIR}/hosts.toml" <<EOF
        [host."http://${reg_name}:5000"]
        EOF
        done
      - task: docker-network:connect
        vars:
          net: kind
          container: kind-registry
      - |
        kubectl apply -f - <<EOF
        ---
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: local-registry-hosting
          namespace: kube-public
        data:
          localRegistryHosting.v1: |
            host: "localhost:5000"
            help: "https://kind.sigs.k8s.io/docs/user/local-registry/"
        EOF
  delete:
    cmds:
      - task: kind:delete
      - task: docker-registry:delete
