---
- name: Install metallb
  hosts:
    - localhost
  vars:
    contexts:
      - console
  tasks:
    - name: Add metallb helm chart repository
      kubernetes.core.helm_repository:
        name: metallb
        repo_url: https://metallb.github.io/metallb
    - name: Install metallb/metallb
      with_items: '{{ contexts }}'
      kubernetes.core.helm:
        chart_ref: metallb/metallb
        chart_version: 0.14.4
        create_namespace: "true"
        release_name: metallb
        release_namespace: metallb-system
        context: '{{ item }}'
        state: present
    - name: Define IPAddressPool
      with_items: '{{ contexts }}'
      kubernetes.core.k8s:
        state: present
        context: '{{ item }}'
        definition:
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: metallb-ipaddresspool
            namespace: metallb-system
          spec:
            addresses:
              - 10.88.0.1-10.88.0.254
    - name: Define L2Advertisement
      with_items: '{{ contexts }}'
      kubernetes.core.k8s:
        state: present
        context: '{{ item }}'
        definition:
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: metallb-l2advertisement
            namespace: metallb-system
          spec:
            ipAddressPools:
              - metallb-ipaddresspool
