---
version: '3'
tasks:
  _create:
    vars:
      n: '{{ .n }}'
      s: '{{ .s }}'
      args: '{{ .args }}'
    cmds:
      - |
        kubectl \
          create \
          secret \
          generic \
          -n {{ .n | quote }} \
          {{ .s | quote }} \
          {{ .args }}
  create:
    vars:
      n: '{{ .n }}'
      s: '{{ .s }}'
      args: '{{ .args }}'
    cmds:
      - task: _create
        vars:
          n: '{{ .n }}'
          s: '{{ .s }}'
          args: '{{ .args }}'
    status:
      - kubectl get secret -n {{ .n | quote }} {{ .s | quote }}
  delete:
    vars:
      n: '{{ .n }}'
      s: '{{ .s }}'
    cmds:
      - |
        kubectl \
          delete \
          secret \
          -n {{ .n | quote }} \
          {{ .s | quote }}
  get:
    vars:
      n: '{{ .n }}'
      s: '{{ .s }}'
      f: '{{ .f }}'
    cmds:
      - |
        kubectl get secret \
          -n {{ .n | quote }} \
          {{ .s }} -o json | \
          jq -r '.data.{{ .f }}' | \
          base64 -d
  seal:
    vars:
      n: '{{ .n }}'
      s: '{{ .s }}'
      literals: '{{ .literals | default "--from-literal=foo=bar" }}'
    cmds:
      - task: _create
        vars:
          n: '{{ .n }}'
          s: '{{ .s }}'
          literals: '{{ .literals | default "--from-literal=foo=bar" }}'
          args: >-
            --dry-run=client
            {{ .literals }}
            -o yaml | kubeseal | kubectl apply -f -
