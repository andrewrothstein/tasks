---
version: '3'
includes:
  k: kubectl.yml
  argo-release:
    taskfile: argo-release.yml
    internal: true
    vars:
      chart: argo-workflows
      chart_ver: 0.41.11
      name: argo
      namespace: argo
      create_namespace: 'true'
      install: 'true'
      helm_args: -f argo-workflows-values.yml
tasks:
  default:
    deps:
      - upgrade
  upgrade:
    cmds:
      - task: argo-release:upgrade
      - task: k:apply
        vars:
          f: argo-templates
  delete:
    cmds:
      - task: argo-release:delete
  list:
    vars:
      n: '{{ .n | default "argo" }}'
    cmds:
      - argo list -n {{ .n | quote }}
  submit:
    vars:
      n: '{{ .n | default "argo" }}'
      dry_run: '{{ .dry_run | default "false" }}'
      from: '{{ .from }}'
      generate_from: '{{ .generate_from }}'
      f: '{{ .f }}'
      log: '{{ .log | default "true" }}'
      watch: '{{ .watch | default "true" }}'
      serviceaccount: '{{ .serviceaccount | default "workflows" }}'
    cmds:
      - |-
        argo submit
          {{- if .n }} \
          -n {{ .n | quote }}
          {{- end }}
          {{- if eq "true" .dry_run }} \
          --dry-run
          {{- end }}
          {{- if .generate_name }} \
          --generate-name={{ .generate_name | quote }}
          {{- end }}
          {{- if .from }} \
          --from={{ .from | quote }}
          {{- end }}
          {{- if eq "true" .watch }} \
          --watch
          {{- end }}
          {{- if eq "true" .log }} \
          --log
          {{- end }}
          {{- if .serviceaccount }} \
          --serviceaccount={{ .serviceaccount | quote }}
          {{- end }}
          {{- if .f }} \
          {{ .f | quote }}
          {{- end }}
  test:
    cmds:
      - task: submit
        vars:
          n: argo
          from: wftmpl/hello-world
  port-forward:
    cmds:
      - kubectl -n argo port-forward deployment/argo-server 2746:2746
