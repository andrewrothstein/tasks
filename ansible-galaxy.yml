---
version: '3'
includes:
  gh: gh.yml
tasks:
  role-init:
    dotenv: [.galaxy-secrets.env]
    vars:
      roles_dir: '{{ .roles_dir | default "${HOME}/git/github.com/andrewrothstein" }}'
      name: '{{ .name }}'
    cmds:
      - |
        cd {{ .roles_dir | default .USER_WORKING_DIR | quote }};
        ansible-galaxy role init {{ .name | quote }}
  import:
    dotenv: [.galaxy-secrets.env]
    vars:
      org: '{{ .org | default "andrewrothstein" }}'
      name: '{{ .name }}'
      branch: '{{ .branch | default "" }}'
    cmds:
      - |
        if [[ -z {{ .branch | quote }} ]];
        then
          branch="$(gh repo view --json defaultBranchRef {{ .org }}/ansible-{{ .name }} | jq -r .defaultBranchRef.name)"
        else
          branch={{ .branch | quote }}
        fi
        ansible-galaxy \
          role \
            import \
              --branch "$branch" \
              --token "${ANSIBLE_GALAXY_TOKEN}" \
              --role-name {{ .name | quote }} \
              {{ .org | quote }} \
              "ansible-{{ .name }}"
  install:
    vars:
      requirements_dir: '{{ .requirements_dir | default .USER_WORKING_DIR }}'
      requirements: '{{ .requirements | default "requirements.yml" }}'
      fq_requirements: '{{ .requirements_dir }}/{{ .requirements }}'
      force: '{{ .force | default false }}'
    cmds:
      - |
        if [ -e {{ .fq_requirements | quote }} ];
        then
          ansible-galaxy \
            install \
            {{ if .force }}-f{{ end }} \
            -r {{ .fq_requirements | quote }}
        else
          echo {{ .fq_requirements | quote }} not found, skipping...
        fi
