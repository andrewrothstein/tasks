---
version: '3'
tasks:
  role-import:
    dotenv: [.galaxy-secrets.env]
    vars:
      org: '{{ .org | default "andrewrothstein" }}'
      name: '{{ .name }}'
      branch: '{{ .branch | default "main" }}'
    cmds:
      - |
        ansible-galaxy \
          role \
            import \
              --branch {{ .branch | quote }} \
              --token "${ANSIBLE_GALAXY_TOKEN}" \
              {{ .org | quote }} \
              {{ .name | quote }}
  install:
    vars:
      requirements_dir: '{{ .requirements_dir | default .USER_WORKING_DIR }}'
      requirements: '{{ .requirements | default "requirements.yml" }}'
      fq_requirements: '{{ .requirements_dir }}/{{ .requirements }}'
      force: '{{ .force | default false }}'
    cmds:
      - |
        if [ -e {{ .fq_requirements | quote }} ];
        then
          ansible-galaxy \
            install \
            {{ if .force }}-f{{ end }} \
            -r {{ .fq_requirements | quote }}
        else
          echo {{ .fq_requirements | quote }} not found, skipping...
        fi
