---
version: '3'
vars:
  mirror: https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources
  default_ver: 25.0.4
  crd1: kubernetes/keycloaks.k8s.keycloak.org-v1.yml
  crd2: kubernetes/keycloakrealmimports.k8s.keycloak.org-v1.yml
  operator: kubernetes/kubernetes.yml
  n: keycloak
includes:
  kk:
    internal: true
    taskfile: kubectl.yml
    vars:
      labels: istio.io/dataplane-mode=ambient
  instance:
    internal: true
    taskfile: kubectl.yml
    vars:
      literal_f: |
        ---
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: keycloak-tls
        spec:
          secretName: keycloak-tls
          subject:
            organizationalUnits:
              - keycloak-operator
          dnsNames:
            - keycloak
            - keycloak.keycloak
          issuerRef:
            name: selfsigned-cluster-issuer
            kind: ClusterIssuer
            group: cert-manager.io
        ---
        apiVersion: k8s.keycloak.org/v2alpha1
        kind: Keycloak
        metadata:
          name: keycloak
        spec:
          http:
            httpEnabled: true
            tlsSecret: keycloak-tls
          hostname:
            strict: false
          proxy:
            headers: forwarded
tasks:
  default:
    cmds:
      - task: apply
  apply:
    cmds:
      - task: operator-apply
      - task: instance-apply
  delete:
    cmds:
      - task: instance-delete
      - task: operator-delete
  instance-apply:
    deps:
      - task: instance:apply
  instance-delete:
    deps:
      - task: instance:delete
  operator-apply:
    vars:
      ver: '{{ .ver | default .default_ver }}'
    cmds:
      - task: kk:ns-create
      - task: kk:ns-label
      - task: kk:apply
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .crd1 }}'
      - task: kk:apply
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .crd2 }}'
      - task: kk:apply
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .operator }}'
  operator-delete:
    vars:
      ver: '{{ .ver | default .default_ver }}'
    cmds:
      - task: kk:delete
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .operator }}'
      - task: kk:delete
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .crd2 }}'
      - task: kk:delete
        vars:
          f: '{{ .mirror }}/{{ .ver }}/{{ .crd1 }}'
      - task: kk:ns-delete
