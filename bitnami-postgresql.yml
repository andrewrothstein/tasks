---
version: '3'
includes:
  bitnami-chart: bitnami-chart.yml
tasks:
  default:
    deps:
      - task: install
        vars:
          CREATE_NAMESPACE: true
  install:
    vars:
      CHART: '{{ .CHART | default "postgresql" }}'
      CHART_VER: '{{ .CHART_VER | default "12.5.6" }}'
      NAME: '{{ .NAME | default "postgresql" }}'
      NAMESPACE: '{{ .NAMESPACE | default "bitnami-postgresql" }}'
      CREATE_NAMESPACE: '{{ .CREATE_NAMESPACE }}'
      ADMIN_USERNAME: '{{ .ADMIN_USERNAME | default "pgadmin" }}'
      ADMIN_PASSWORD: '{{ .ADMIN_PASSWORD | default "password" }}'
      ADMIN_DB: '{{ .ADMIN_DB | default "pgadmin" }}'
      DB_SIZE: '{{ .DB_SIZE | default "10Gi" }}'
    cmds:
      - task: bitnami-chart:install
        vars:
          CHART: '{{ .CHART }}'
          CHART_VER: '{{ .CHART_VER }}'
          NAME: '{{ .NAME }}'
          NAMESPACE: '{{ .NAMESPACE }}'
          CREATE_NAMESPACE: '{{ .CREATE_NAMESPACE }}'
          HELM_ARGS: >-
            --set auth.username={{ .ADMIN_USERNAME | quote }}
            --set auth.password={{ .ADMIN_PASSWORD | quote }}
            --set auth.database={{ .ADMIN_DB | quote }}
            --set persistence.size={{ .DB_SIZE | quote }}
  delete:
    vars:
      NAME: '{{ .NAME }}'
      NAMESPACE: '{{ .NAMESPACE }}'
    cmds:
      - task: bitnami-chart:delete
        vars:
          NAME: '{{ .NAME | default "postgresql" }}'
          NAMESPACE: '{{ .NAMESPACE | default "bitnami-postgresql" }}'
