---
version: '3'
tasks:
  install:
    vars:
      NAMESPACE: '{{ .NAMESPACE }}'
      CREATE_NAMESPACE: '{{ .CREATE_NAMESPACE | default false }}'
      NAME: '{{ .NAME }}'
      CHART_REPO_NAME: '{{ .CHART_REPO_NAME }}'
      CHART: '{{ .CHART }}'
      CHART_VER: '{{ .CHART_VER }}'
      WAIT: '{{ .WAIT | default true }}'
      TIMEOUT: '{{ .TIMEOUT | default "10m" }}'
      HELM_ARGS: '{{ .HELM_ARGS | default "" }}'
    cmds:
      - |
        helm \
          install
          {{- if .NAMESPACE }} \
          -n {{ .NAMESPACE | quote }}
          {{- end }}
          {{- if eq "true" .CREATE_NAMESPACE }}  \
          --create-namespace
          {{- end }} \
          {{ .NAME | quote }} \
          {{ if .CHART_REPO_NAME }}{{ .CHART_REPO_NAME }}/{{ end -}}
          {{- .CHART -}}
          {{- if .CHART_VER }} \
          --version {{ .CHART_VER | quote }}
          {{- if eq "true" .WAIT }} --wait --timeout {{ .TIMEOUT | quote }}{{ end }}
          {{- end }}
          {{- if .HELM_ARGS }} \
          {{ .HELM_ARGS }}{{ end }}
    status:
      - |
        helm \
          list \
          -n {{ .NAMESPACE | quote }} \
          -o json \
          | jq -e '.[] | select(.name=={{ .NAME | quote }})'
  delete:
    vars:
      NAMESPACE: '{{ .NAMESPACE }}'
      NAME: '{{ .NAME }}'
      WAIT: '{{ .WAIT | default true }}'
    preconditions:
      - |
        helm \
          list
          {{- if .NAMESPACE }} \
          -n {{ .NAMESPACE | quote }}
          {{- end }} \
          -o json \
          | jq -e '.[] | select(.name=={{ .NAME | quote }})'
    cmds:
      - |
        helm \
          delete
          {{- if .NAMESPACE }} \
          -n {{ .NAMESPACE | quote }}
          {{- end }}
          {{- if eq "true" .WAIT }} \
          --wait
          {{- end }} \
          {{ .NAME | quote }}
