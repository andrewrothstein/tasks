---
version: '3'
tasks:
  install:
    vars:
      NAMESPACE: '{{ .NAMESPACE }}'
      CREATE_NAMESPACE: '{{ .CREATE_NAMESPACE }}'
      NAME: '{{ .NAME }}'
      CHART_REPO_NAME: '{{ .CHART_REPO_NAME }}'
      CHART: '{{ .CHART }}'
      CHART_VER: '{{ .CHART_VER }}'
      HELM_ARGS: '{{ .HELM_ARGS | default "" }}'
    cmds:
      - |
        helm \
          install \
          -n {{ .NAMESPACE | quote }}
          {{- if .CREATE_NAMESPACE }}  \
          --create-namespace
          {{- end }} \
          {{ .NAME | quote }} \
          {{ if .CHART_REPO_NAME }}{{ .CHART_REPO_NAME }}/{{ end -}}
          {{- .CHART -}}
          {{- if .CHART_VER }} \
          --version {{ .CHART_VER | quote }}
          {{- end }}
          {{- if .HELM_ARGS }} \
          {{ .HELM_ARGS }}{{ end }}
    status:
      - |
        helm \
          list \
          -n {{ .NAMESPACE | quote }} \
          -o json \
          | jq -e '.[] | select(.name=={{ .NAME | quote }})'
  delete:
    vars:
      NAMESPACE: '{{ .NAMESPACE }}'
      NAME: '{{ .NAME }}'
    preconditions:
      - |
        helm \
          list \
          -n {{ .NAMESPACE | quote }} \
          -o json \
          | jq -e '.[] | select(.name=={{ .NAME | quote }})'
    cmds:
      - |
        helm \
          delete \
          -n {{ .NAMESPACE | quote }} \
          {{ .NAME | quote }}
