---
version: '3'
includes:
  docker-run: docker-run.yml
tasks:
  apply:
    vars:
      name: '{{ .name }}'
      restart: '{{ .restart | default "always" }}'
      u: '{{ .u | default .user | default "nobody" }}'
      net: '{{ .net }}'
      ip: '{{ .ip }}'
      privileged: '{{ .privileged }}'
      args: '{{ .args }}'
      image: '{{ .image }}'
    cmds:
      - task: docker-run:apply
        vars:
          name: '{{ .name }}'
          d: 'true'
          restart: '{{ .restart }}'
          u: '{{ .u }}'
          net: '{{ .net }}'
          ip: '{{ .ip }}'
          privileged: '{{ .privileged }}'
          args: '{{ .args }}'
          image: '{{ .image }}'
    status:
      - |
        docker ps \
          --filter "name={{ .name }}" \
          --format '{"Names":{{ "{{ .Names }}" | quote }} }' \
          | jq -e -s '.[] | select(.Names=={{ .name | quote}})'
  delete:
    vars:
      name: '{{ .name }}'
    cmds:
      - docker rm -f {{ .name | quote }}
