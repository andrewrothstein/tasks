---
version: '3'
includes:
  kubectl-exec:
    taskfile: kubectl-exec.yml
    vars:
      ke_cmd: vault
      n: vault
  argo:
    taskfile: argo.yml
    vars:
      n: vault
tasks:
  init:
    cmds:
      - task: kubectl-exec
  status:
    cmds:
      - task: argo:submit
        vars:
          from: wftmpl/status
  init:
    vars:
      selector: '{{ .selector | default "vault-0" }}'
    cmds:
      - task: kubectl-exec
        vars:
          selector: '{{ .selector }}'
          ke_args: operator init -key-shares=1 -key-threshold=1 -format=json
          output: .vault-secrets.json
  unseal:
    vars:
      selector: '{{ .selector | default "vault-0" }}'
    cmds:
      - task: kubectl-exec
        vars:
          selector: '{{ .selector }}'
          ke_args: operator unseal "$(jq -r '.unseal_keys_b64[]' .vault-secrets.json)"
  unseal-all:
    cmds:
      - task: unseal
        vars:
          selector: vault-0
      - task: unseal
        vars:
          selector: vault-1
      - task: unseal
        vars:
          selector: vault-2
  join:
    vars:
      selector: '{{ .selector | default "vault-0" }}'
      join: '{{ .join | default "http://vault-0.vault-internal:8200" }}'
    cmds:
      - task: kubectl-exec
        vars:
          selector: '{{ .selector }}'
          ke_args: operator raft join {{ .join | quote }}
  join-all:
    deps:
      - task: join
        vars:
          selector: vault-1
      - task: join
        vars:
          selector: vault-2
