---
version: '3'
tasks:
  install:
    cmds:
      - docker run --privileged --rm tonistiigi/binfmt --install all
      - |
        docker buildx create --use \
          --name mybuilder \
          --driver docker-container
  bake:
    vars:
      builder: '{{ .builder }}'
      f: '{{ .f }}'
      load: '{{ .load }}'
      print: '{{ .print }}'
      pull: '{{ .pull }}'
      push: '{{ .push }}'
      no_cache: '{{ .no_cache }}'
      args: '{{ .args }}'
    cmds:
      - |-
        docker buildx bake
        {{- if .builder }} \
          --builder {{ .builder | default "default" }}
        {{- end }}
        {{- if .f }} \
          -f {{ .f }}
        {{- end }}
        {{- if .load }} \
          --load
        {{- end }}
        {{- if .print }} \
          --print
        {{- end }}
        {{- if .pull }} \
          --pull
        {{- end }}
        {{- if .push }} \
          --push
        {{- end }}
        {{- if .no_cache }} \
          --no-cache
        {{- end }}
        {{- if .args }} \
          {{ .args }}
        {{- end }}
  test:
    deps:
      - task: bake
        vars:
          f: docker-bake.hcl
          pull: true
          args: only
      - task: bake
        vars:
          f: docker-bake.hcl
          pull: true
          args: both
