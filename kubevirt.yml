---
version: '3'
vars:
  kubevirt_mirror: https://github.com/kubevirt/kubevirt/releases/download
  kubevirt_v: 1.3.1
  kubevirt_releases: '{{ .kubevirt_mirror }}/v{{ .kubevirt_v }}'
  kubevirt_operator_yaml: '{{ .kubevirt_releases }}/kubevirt-operator.yaml'
  kubevirt_cr_yaml: '{{ .kubevirt_releases }}/kubevirt-cr.yaml'
includes:
  kubectl:
    internal: true
    taskfile: kubectl.yml
    vars:
      n: kubevirt
tasks:
  enable_nested_virtualization:
    cmds:
      - task: kubectl:patch
        vars:
          typeofthing: kubevirt
          thingname: kubevirt
          ty: merge
          patch: '{"spec":{"configuration":{"developerConfiguration":{"useEmulation":true}}}}'
  apply_operator:
    cmds:
      - task: kubectl:apply
        vars:
          f: '{{ .kubevirt_operator_yaml }}'
  apply_crs:
    cmds:
      - task: kubectl:apply
        vars:
          f: '{{ .kubevirt_cr_yaml }}'
  apply:
    cmds:
      - task: kubectl:ns-create
      - task: apply_operator
      - task: apply_crs
      - task: enable_nested_virtualization
  delete:
    cmds:
      - task: kubectl:ns-delete
  default:
    deps:
      - apply
