---
version: '3'
vars:
  kubevirt_ns: kubevirt
  kubevirt_v: 0.58.0
  kubevirt_mirror: https://github.com/kubevirt/kubevirt/releases/download
  kubevirt_typeofthing: kubevirt
  kubevirt_thingname: kubevirt
includes:
  kubectl:
    internal: true
    taskfile: kubectl.yml
    vars:
      n: '{{ .kubevirt_ns }}'
tasks:
  apply:
    cmds:
      - task: kubectl:ns-create
      - task: kubectl:apply
        vars:
          f: '{{ .kubevirt_mirror }}/v{{ .kubevirt_v }}/kubevirt-operator.yaml'
      - task: kubectl:apply
        vars:
          f: '{{ .kubevirt_mirror }}/v{{ .kubevirt_v }}/kubevirt-cr.yaml'
      - |
        # enable nested-virtualization
        kubectl \
          -n {{ .kubevirt_ns | quote }} \
          patch \
          {{ .kubevirt_typeofthing | quote }} \
          {{ .kubevirt_thingname | quote }} \
          --type=merge \
          --patch '{"spec":{"configuration":{"developerConfiguration":{"useEmulation":true}}}}'
  delete:
    cmds:
      - task: kubectl:delete
        vars:
          f: '{{ .kubevirt_mirror }}/v{{ .kubevirt_v }}/kubevirt-cr.yaml'
      - task: kubectl:delete
        vars:
          f: '{{ .kubevirt_mirror }}/v{{ .kubevirt_v }}/kubevirt-operator.yaml'
      - task: kubectl:ns-delete
  default:
    deps:
      - apply
