---
version: '3'
includes:
  kubectl:
    internal: true
    taskfile: kubectl.yml
tasks:
  ns-create:
    cmds:
      - task: kubectl:ns-create
        vars:
          n: '{{ .n | default "kubevirt" }}'
  apply-kubevirt-operator:
    vars:
      n: '{{ .n | default "kubevirt" }}'
      v: '{{ .v | default "0.58.0" }}'
      mirror: '{{ .mirror | default "https://github.com/kubevirt/kubevirt/releases/download" }}'
    deps:
      - ns-create
    cmds:
      - task: kubectl:apply
        vars:
          n: '{{ .n }}'
          f: '{{ .mirror }}/v{{ .v }}/kubevirt-operator.yaml'
      - task: kubectl:apply
        vars:
          n: '{{ .n }}'
          f: '{{ .MIRROR }}/v{{ .v }}/kubevirt-cr.yaml'
  enable-nested-virtualization:
    vars:
      n: '{{ .n | default "kubevirt" }}'
      typeofthing: '{{ .t | default "kubevirt" }}'
      thingname: '{{  .thingname | default "kubevirt" }}'
    deps:
      - ns-create
    cmds:
      - |
        # enable nested-virtualization
        kubectl \
          -n {{ .n | quote }} \
          patch \
          {{ .typeofthing | quote }} \
          {{ .thingname | quote }} \
          --type=merge \
          --patch '{"spec":{"configuration":{"developerConfiguration":{"useEmulation":true}}}}'
  apply-cdi-operator:
    vars:
      n: '{{ .n | default "cdi" }}'
      v: '{{ .v | default "1.55.2" }}'
      mirror: '{{ .mirror | default "https://github.com/kubevirt/containerized-data-importer/releases/download" }}'
    cmds:
      - task: kubectl:ns-create
        vars:
          n: '{{ .n }}'
      - task: kubectl:apply
        vars:
          n: '{{ .n }}'
          f: '{{ .MIRROR_CDI }}/v{{ .v }}/cdi-operator.yaml'
      - task: kubectl:apply
        vars:
          n: '{{ .n }}'
          f: '{{ .MIRROR_CDI }}/v{{ .v }}/cdi-cr.yaml'
  apply:
    deps:
      - apply-kubevirt-operator
      - apply-cdi-operator
      - enable-nested-virtualization
  default:
    cmds:
      - task: apply
