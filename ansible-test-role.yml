---
version: '3'
includes:
  galaxy:
    taskfile: ansible-galaxy.yml
  local:
    taskfile: ansible-local.yml
  dcb:
    taskfile: dcb.yml
tasks:
  local:
    cmds:
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/requirements.yml'
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/meta/requirements.yml'
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/test-requirements.yml'
      - task: local:playbook
        vars:
          playbook: '{{ .USER_WORKING_DIR }}/test.yml'
  default:
    deps:
      - dcb:install
    cmds:
      - task: dcb:default
        vars:
          dcb: '{{ .dcb | default "dcb" }}'
  generate-checksum:
    internal: true
    vars:
      append: '{{ .append | default false }}'
      dl: '{{ .dl }}'
      target: '{{ .target }}'
    cmds:
      - |
        if [ -e {{ .dl | quote }} ];
        then
          '{{ .dl }}' {{ if .append }} >> {{ .t | quote }}{{ end }}
        fi
  generate-checksums:
    vars:
      append: '{{ .append | default false }}'
      target: '{{ .USER_WORKING_DIR }}/defaults/main.yml'
    cmds:
      - task: generate-checksum
        vars:
          append: '{{ .append }}'
          dl: '{{ .USER_WORKING_DIR }}/dl-checksum.sh'
          target: '{{ .target }}'
      - task: generate-checksum
        vars:
          append: '{{ .append }}'
          dl: '{{ .USER_WORKING_DIR }}/dl-checksums.sh'
          target: '{{ .target }}'
