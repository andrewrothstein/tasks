---
version: '3'
includes:
  ansible-galaxy:
    taskfile: ansible-galaxy.yml
  local:
    taskfile: ansible.yml
    vars:
      i: 'localhost,'
      c: local
      target: localhost
      limit: localhost
  dcb:
    taskfile: dcb.yml
tasks:
  clone:
    vars:
      git_org: '{{ .git_org | default "https://github.com/andrewrothstein" }}'
      roles_dir: '{{ .roles_dir | default "${HOME}/git/github.com/andrewrothstein" }}'
      name: '{{ .name }}'
      infix: '{{ .infix | default "-" }}'
    cmds:
      - |
        git clone \
          "{{ .git_org }}/ansible{{ .infix }}{{ .name }}" \
          "{{ .roles_dir }}/ansible{{ .infix }}{{ .name }}"
    status:
      - test -d "{{ .roles_dir }}/ansible{{ .infix }}{{ .name }}"
  local:
    cmds:
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/requirements.yml'
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/meta/requirements.yml'
      - task: ansible-galaxy:install
        vars:
          requirements: '{{ .USER_WORKING_DIR }}/test-requirements.yml'
      - task: local:playbook
        vars:
          playbook: '{{ .USER_WORKING_DIR }}/test.yml'
  default:
    deps:
      - task: dcb:install
    cmds:
      - task: dcb:default
        vars:
          pushall: '{{ .pushall | default true }}'
  generate-checksum:
    internal: true
    vars:
      append: '{{ .append }}'
      dl: '{{ .dl }}'
      target: '{{ .target }}'
    cmds:
      - |
        if [ -e {{ .dl | quote }} ];
        then
          {{ .dl | quote }}{{ if eq .append "true" }} >> {{ .target | quote }}{{ end }}
        else
          echo {{ .dl | quote }} not found. skipping...
        fi
  generate-checksums:
    vars:
      target: '{{ .USER_WORKING_DIR }}/defaults/main.yml'
      append: '{{ .append | default false }}'
    cmds:
      - task: generate-checksum
        vars:
          dl: '{{ .USER_WORKING_DIR }}/dl-checksum.sh'
          append: '{{ .append }}'
          target: '{{ .target }}'
      - task: generate-checksum
        vars:
          dl: '{{ .USER_WORKING_DIR }}/dl-checksums.sh'
          append: '{{ .append }}'
          target: '{{ .target }}'
