---
version: '3'
includes:
  gh: gh.yml
  ansible-galaxy: ansible-galaxy.yml
  local:
    taskfile: ansible.yml
    vars:
      i: 'localhost,'
      c: local
      target: localhost
      limit: localhost
  dcb:
    taskfile: dcb.yml
tasks:
  sauce:
    internal: true
    vars:
      dir: '{{ .dir }}'
    deps:
      - task: gh:rename-default-branch
        vars:
          repo_dir: '{{ .dir }}'
    cmds:
      - |
        cd {{ .dir | quote }};
        gengithubactions;
        if [ -e "requirements.txt" ];
        then
          git rm -f requirements.txt
        fi;
  create:
    vars:
      git_org: '{{ .git_org | default "https://github.com/andrewrothstein" }}'
      roles_dir: '{{ .roles_dir | default "${HOME}/git/github.com/andrewrothstein" }}'
      name: '{{ .name }}'
      infix: '{{ .infix | default "-" }}'
      role_name: ansible{{ .infix }}{{ .name }}
      git_repo: '{{ .git_org }}/{{ .role_name }}'
      dir: '{{ .roles_dir }}/{{ .role_name }}'
      public: true
    cmds:
      - task: ansible-galaxy:role-init
        vars:
          roles_dir: '{{ .roles_dir }}'
          name: '{{ .name }}'
      - |
        cd {{ .roles_dir | quote }};
        galaxify {{ .name | quote }};
        mv {{ .name | quote }} {{ .role_name | quote }};
      - task: gh:create-repo
        vars:
          dir: '{{ .roles_dir }}'
          repo: '{{ .role_name }}'
  clone:
    vars:
      git_org: '{{ .git_org | default "https://github.com/andrewrothstein" }}'
      roles_dir: '{{ .roles_dir | default "${HOME}/git/github.com/andrewrothstein" }}'
      name: '{{ .name }}'
      infix: '{{ .infix | default "-" }}'
      role_name: ansible{{ .infix }}{{ .name }}
      git_repo: '{{ .git_org }}/{{ .role_name }}'
      dir: '{{ .roles_dir }}/{{ .role_name }}'
    cmds:
      - git clone {{ .git_repo | quote }} {{ .dir | quote }}
      - task: sauce
        vars:
          dir: '{{ .dir }}'
      - task: ansible-galaxy:role-import
        vars:
          name: '{{ .name }}'
    status:
      - test -d {{ .dir | quote }}
  local:
    cmds:
      - task: ansible-galaxy:install
      - task: ansible-galaxy:install
        vars:
          requirements_dir: '{{ .USER_WORKING_DIR }}/meta'
      - task: ansible-galaxy:install
        vars:
          requirements: test-requirements.yml
      - task: local:playbook
        vars:
          playbook: test.yml
  default:
    deps:
      - task: dcb:install
    cmds:
      - task: dcb:default
        vars:
          pushall: '{{ .pushall | default "true" }}'
  generate-checksum:
    internal: true
    vars:
      append: '{{ .append }}'
      dl: '{{ .dl }}'
      target: '{{ .target }}'
    cmds:
      - |
        if [ -e {{ .dl | quote }} ];
        then
          {{ .dl | quote }}{{ if eq .append "true" }} >> {{ .target | quote }}{{ end }}
        else
          echo {{ .dl | quote }} not found. skipping...
        fi
  generate-checksums:
    vars:
      target: '{{ .USER_WORKING_DIR }}/defaults/main.yml'
      append: '{{ .append | default false }}'
    cmds:
      - task: generate-checksum
        vars:
          dl: '{{ .USER_WORKING_DIR }}/dl-checksum.sh'
          append: '{{ .append }}'
          target: '{{ .target }}'
      - task: generate-checksum
        vars:
          dl: '{{ .USER_WORKING_DIR }}/dl-checksums.sh'
          append: '{{ .append }}'
          target: '{{ .target }}'
