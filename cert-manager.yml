---
version: '3'
includes:
  jetstack: jetstack.yml
  kubectl:
    taskfile: kubectl.yml
    internal: true
    vars:
      n: cert-manager
      labels: 'istio.io/dataplane-mode=ambient'
  cm:
    taskfile: helm.yml
    internal: true
    vars:
      namespace: cert-manager
      name: cert-manager
      chart_repo_name: jetstack
      chart_ver: v1.16.0
      chart: cert-manager
      helm_args: -f cert-manager-values.yml
  approver_policy:
    taskfile: helm.yml
    internal: true
    vars:
      namespace: cert-manager
      name: cert-manager-approver-policy
      chart_repo_name: jetstack
      chart_ver: v0.15.2
      chart: cert-manager-approver-policy
      helm_args: -f cert-manager-approver-policy-values.yml
  csi_driver:
    taskfile: helm.yml
    internal: true
    vars:
      namespace: cert-manager
      name: cert-manager-csi-driver
      chart_repo_name: jetstack
      chart_ver: v0.10.1
      chart: cert-manager-csi-driver
  trust_manager:
    taskfile: helm.yml
    internal: true
    vars:
      namespace: cert-manager
      name: trust-manager
      chart_repo_name: jetstack
      chart_ver: v0.12.0
      chart: trust-manager
  ss:
    taskfile: kubectl.yml
    internal: true
    vars:
      n: cert-manager
      f: cert-manager-selfsigned-cluster-issuer.yml
tasks:
  default:
    deps:
      - upgrade
  check:
    deps:
      - task: jetstack
    cmds:
      - task: cm:check
      - task: approver_policy:check
      - task: csi_driver:check
      - task: trust_manager:check
  upgrade:
    deps:
       - task: jetstack
    cmds:
      - task: kubectl:ns-create
      - task: kubectl:ns-label
      - task: cm:upgrade
      - task: approver_policy:upgrade
      - task: kubectl:apply
        vars:
          f: approver-policy.yml
      - task: csi_driver:upgrade
      - task: ss:apply
      - task: trust_manager:upgrade
  delete:
    cmds:
      - task: trust_manager:delete
      - task: ss:delete
      - task: csi_driver:delete
      - task: kubectl:delete
        vars:
          f: approver-policy.yml
      - task: approver_policy:delete
      - task: cm:delete
      - task: kubectl:ns-delete
