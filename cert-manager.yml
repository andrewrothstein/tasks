---
version: '3'
includes:
  jetstack: jetstack.yml
  helm:
    taskfile: helm.yml
    internal: true
    vars:
      NAMESPACE: cert-manager
      CHART_REPO_NAME: jetstack
  kubectl:
    taskfile: kubectl.yml
    internal: true
    vars:
      n: cert-manager
tasks:
  default:
    deps:
      - install
  install:
    vars:
      INSTALL_CRDS: '{{ .INSTALL_CRDS | default true }}'

      CERTMANAGER_NAME: '{{ .CERTMANAGER_NAME | default "cert-manager" }}'
      CERTMANAGER_CHART_VER: '{{ .CERTMANAGER_CHART_VER | default "1.11.0" }}'

      CERTMANAGER_APPROVERPOLICY_NAME: '{{ .CERTMANAGER_APPROVERPOLICY_NAME | default "cert-manager-approver-policy" }}'
      CERTMANAGER_APPROVERPOLICY_CHART_VER: '{{ .CERTMANAGER_APPROVERPOLICY_CHART_VER | default "0.6.2" }}'

      CERTMANAGER_CSIDRIVER_NAME: '{{ .CERTMANAGER_CSIDRIVER_NAME | default "cert-manager-csi-driver" }}'
      CERTMANAGER_CSIDRIVER_CHART_VER: '{{ .CERTMANAGER_CSIDRIVER_CHART_VER | default "0.5.0" }}'
    deps:
      - task: jetstack
    cmds:
      - task: helm:install
        vars:
          CREATE_NAMESPACE: true
          NAME: '{{ .CERTMANAGER_NAME }}'
          CHART: cert-manager
          CHART_VER: '{{ .CERTMANAGER_CHART_VER }}'
          HELM_ARGS: >
            --set installCRDs={{ .INSTALL_CRDS }}
      - task: helm:install
        vars:
          CREATE_NAMESPACE: false
          NAME: '{{ .CERTMANAGER_APPROVERPOLICY_NAME }}'
          CHART: cert-manager-approver-policy
          CHART_VER: '{{ .CERTMANAGER_APPROVERPOLICY_CHART_VER }}'
          HELM_ARGS: ''
      - task: kubectl:apply
        vars:
          f: cert-manager-selfsigned-cluster-issuer.yml
      - task: helm:install
        vars:
          CREATE_NAMESPACE: false
          NAME: '{{ .CERTMANAGER_CSIDRIVER_NAME }}'
          CHART: cert-manager-csi-driver
          CHART_VER: '{{ .CERTMANAGER_CSIDRIVER_CHART_VER }}'
          HELM_ARGS: ''
  delete:
    vars:
      CERTMANAGER_NAME: '{{ .CERTMANAGER_NAME | default "cert-manager" }}'
      CERTMANAGER_APPROVERPOLICY_NAME: '{{ .CERTMANAGER_APPROVERPOLICY_NAME | default "cert-manager-approver-policy" }}'
      CERTMANAGER_CSIDRIVER_NAME: '{{ .CERTMANAGER_CSIDRIVER_NAME | default "cert-manager-csi-driver" }}'
    cmds:
      - task: helm:delete
        vars:
          NAME: '{{ .CERTMANAGER_CSIDRIVER_NAME }}'
      - task: kubectl:delete
        vars:
          f: cert-manager-selfsigned-cluster-issuer.yml
      - task: helm:delete
        vars:
          NAME: '{{ .CERTMANAGER_APPROVERPOLICY_NAME }}'
      - task: helm:delete
        vars:
          NAME: '{{ .CERTMANAGER_NAME }}'
