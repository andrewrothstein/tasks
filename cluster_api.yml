---
version: '3'
vars:
  clusterctl: clusterctl
tasks:
  config-repositories:
    cmds:
      - '{{ .clusterctl | quote }} config repositories -o yaml'
  help:
    cmds:
      - '{{ .clusterctl | quote }} init --help'
  default:
    deps:
      - config-repositories
  init:
    vars:
      # bootstrap provider, e.g. kubeadm:v1.3.3
      b: '{{ .b | default "" }}'
      # control plane provider, e.g. kubeadm:v1.3.3
      c: '{{ .c | default "" }}'
      # infrastructure provider, e.g. vcluster:v0.1.3
      i: '{{ .i | default "" }}'
    cmds:
      - |
        {{ .clusterctl | quote }} \
          init \
          {{ if .b }}-b {{ .b | quote }}{{ end }} \
          {{ if .c }}-c {{ .c | quote }}{{ end }} \
          {{ if .i }}-i {{ .i | quote }}{{ end }}
  workload:
    vars:
      # kubectl command, i.e. apply or delete
      kk: '{{ .kk | default "apply" }}'
      # workload cluster template variant/flavor
      f: '{{ .f }}'
      # workload cluster name
      n: '{{ .n | default "workload-01" }}'
      # workload cluster k8s version
      v: '{{ .v | default "v1.25.3" }}'
      ## cluster size / machine counts
      control_plane_machine_count: '{{ .control_plane_machine_count | default 1 }}'
      worker_machine_count: '{{ .worker_machine_count | default 1 }}'
    env:
      HELM_VALUES: ''
    cmds:
      - |
        {{ .clusterctl | quote }} \
          generate \
          cluster {{ .n | quote }} \
          {{ if .f }}-f {{ .f | quote }}{{ end }} \
          --kubernetes-version {{ .v | quote }} \
          --control-plane-machine-count {{ .control_plane_machine_count }} \
          --worker-machine-count {{ .worker_machine_count }} \
          | kubectl {{ .kk | quote }} -f -
  workload_clusters:
    vars:
      # workload cluster k8s version
      v: '{{ .v | default "v1.25.3" }}'
    deps:
      - task: workload
        vars:
          kk: apply
          n: workload-01
          v: '{{ .v }}'
      - task: workload
        vars:
          kk: apply
          n: workload-02
          v: '{{ .v }}'
  apply:
    vars:
      # workload cluster k8s version
      v: '{{ .v | default "v1.25.3" }}'
    deps:
      - task: init
        vars:
          i: vcluster
    cmds:
      - task: workload_clusters
        vars:
          v: '{{ .v }}'
  delete:
    vars:
      # workload cluster k8s version
      v: '{{ .v | default "v1.25.3" }}'
    deps:
      - task: workload
        vars:
          kk: delete
          n: workload-01
          v: '{{ .v }}'
      - task: workload
        vars:
          kk: delete
          n: workload-02
          v: '{{ .v }}'
